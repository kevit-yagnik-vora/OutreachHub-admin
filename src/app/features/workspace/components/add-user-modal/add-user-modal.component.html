<!-- Modal Overlay -->
<div
  class="fixed inset-0 z-40 bg-black bg-opacity-50"
  (click)="closeModal.emit()"
></div>

<!-- Modal Content -->
<div class="fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="relative w-full max-w-md p-6 bg-white rounded-lg shadow-xl">
    <!-- View 1 & 3: The Form -->
    <form
      *ngIf="currentView === 'ADD_EXISTING' || currentView === 'CREATE_NEW'"
      [formGroup]="addUserForm"
      (ngSubmit)="onSubmit()"
      class="space-y-4"
    >
      <h2 class="text-xl font-bold text-slate-800">
        {{
          currentView === "CREATE_NEW"
            ? "Create & Invite New User"
            : "Add User to Workspace"
        }}
      </h2>

      <div>
        <label for="email" class="block text-sm font-medium text-slate-700"
          >User Email</label
        >
        <input
          formControlName="email"
          id="email"
          type="email"
          placeholder="user@example.com"
          [readOnly]="currentView === 'CREATE_NEW'"
          class="block w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 read-only:bg-slate-100"
        />
      </div>

      <!-- Fields for creating a new user -->
      <div *ngIf="currentView === 'CREATE_NEW'" class="space-y-4">
        <div>
          <label for="name" class="block text-sm font-medium text-slate-700"
            >Full Name</label
          >
          <input
            formControlName="name"
            id="name"
            type="text"
            placeholder="e.g. Alex Green"
            class="block w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
          />
        </div>
        <div>
          <label
            for="phoneNumber"
            class="block text-sm font-medium text-slate-700"
            >Phone Number</label
          >
          <input
            formControlName="phoneNumber"
            id="phoneNumber"
            type="text"
            class="block w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
          />
        </div>
      </div>

      <div>
        <label for="role" class="block text-sm font-medium text-slate-700"
          >Role</label
        >
        <select
          formControlName="role"
          id="role"
          class="block w-full px-3 py-2 mt-1 bg-white border border-slate-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
        >
          <option value="Viewer">Viewer</option>
          <option value="Editor">Editor</option>
        </select>
      </div>

      <div
        *ngIf="apiError"
        class="p-3 text-sm text-red-700 bg-red-100 rounded-md"
      >
        {{ apiError }}
      </div>

      <div class="flex justify-end pt-2 space-x-3">
        <button
          type="button"
          (click)="closeModal.emit()"
          class="px-4 py-2 text-sm font-medium bg-slate-100 rounded-md hover:bg-slate-200"
        >
          Cancel
        </button>
        <button
          type="submit"
          [disabled]="addUserForm.invalid || isSubmitting"
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:bg-indigo-400"
        >
          <span
            *ngIf="isSubmitting"
            class="w-4 h-4 mr-2 border-2 border-white rounded-full border-t-transparent animate-spin"
          ></span>
          {{
            isSubmitting
              ? "Submitting..."
              : currentView === "CREATE_NEW"
              ? "Create & Add"
              : "Add User"
          }}
        </button>
      </div>
    </form>

    <!-- View 2: Confirmation Prompt -->
    <div *ngIf="currentView === 'CONFIRM_CREATE'" class="text-center">
      <h3 class="text-lg font-semibold text-slate-800">User Not Found</h3>
      <p class="mt-2 text-sm text-slate-600">
        The user with email
        <strong class="text-indigo-600">{{
          addUserForm.get("email")?.value
        }}</strong>
        doesn't exist.
      </p>
      <p class="mt-1 text-sm text-slate-600">
        Would you like to create a new account for them and add them to this
        workspace?
      </p>
      <div class="flex justify-center mt-6 space-x-3">
        <button
          (click)="closeModal.emit()"
          class="px-4 py-2 text-sm font-medium bg-slate-100 rounded-md hover:bg-slate-200"
        >
          No, Cancel
        </button>
        <button
          (click)="confirmAndProceedToCreate()"
          class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700"
        >
          Yes, Create User
        </button>
      </div>
    </div>
  </div>
</div>
